#include <minix/syslib.h>
#include <minix/drivers.h>

#include "speaker.h"
#include "timer.h"
#include "i8254.h"

#define MUSIC_SIZE 316
extern unsigned long long rtc_counter;

note_t music[] =
{
//{ 1, 1250 },
{ 440, 250 },
{ 494, 125 },
{ 587, 375 },
{ 740, 2500 },
{ 440, 250 },
{ 494, 125 },
{ 587, 375 },
{ 659, 2500 },
{ 440, 250 },
{ 494, 125 },
{ 587, 375 },
{ 740, 2000 },
{ 988, 125 },
{ 1, 10 },
{ 988, 125 },
{ 1, 10 },
{ 988, 125 },
{ 1, 10 },
{ 988, 125 },
{ 1, 10 },
{ 880, 125 },
{ 1, 88 },
{ 880, 125 },
{ 1, 10 },
{ 880, 125 },
{ 740, 125 },
{ 1, 88 },
{ 740, 125 },
{ 1, 88 },
{ 880, 250 },
{ 440, 125 },
{ 494, 125 },
{ 587, 375 },
{ 659, 500 },
{ 1, 88 },
{ 784, 125 },
{ 740, 125 },
{ 784, 125 },
{ 1, 88 },
{ 784, 125 },
{ 659, 125 },
{ 740, 125 },
{ 1, 88 },
{ 659, 125 },
{ 587, 125 },
{ 659, 125 },
{ 1, 88 },
{ 494, 125 },
{ 1, 125 },
{ 494, 500 },
{ 1, 3250 },
{ 440, 125 },
{ 1, 10 },
{ 440, 125 },
{ 494, 125 },
{ 1, 10 },
{ 494, 125 },
{ 587, 125 },
{ 1, 125 },
{ 740, 375 },
{ 659, 375 },
{ 587, 375 },
{ 659, 125 },
{ 740, 250 },
{ 1, 1250 },
{ 988, 375 },
{ 880, 250 },
{ 988, 250 },
{ 740, 375 },
{ 659, 375 },
{ 587, 375 },
{ 494, 375 },
{ 440, 188 },
{ 494, 250 },
{ 1, 1375 },
{ 440, 250 },
{ 1, 10 },
{ 440, 125 },
{ 1, 10 },
{ 440, 125 },
{ 1, 10 },
{ 494, 125 },
{ 1, 10 },
{ 587, 125 },
{ 740, 125 },
{ 1, 10 },
{ 740, 250 },
{ 659, 375 },
{ 587, 375 },
{ 659, 125 },
{ 740, 250 },
{ 659, 125 },
{ 740, 250 },
{ 1, 1500 },
{ 440, 125 },
{ 1, 10 },
{ 440, 125 },
{ 494, 250 },
{ 587, 250 },
{ 740, 375 },
{ 659, 375 },
{ 587, 375 },
{ 494, 375 },
{ 440, 125 },
{ 494, 250 },
{ 1, 125 },
{ 1, 1500 },
{ 988, 250 },
{ 880, 250 },
{ 740, 250 },
{ 1, 10 },
{ 740, 125 },
{ 659, 250 },
{ 587, 125 },
{ 740, 500 },
{ 659, 500 },
{ 494, 250 },
{ 587, 250 },
{ 1, 10 },
{ 587, 125 },
{ 659, 250 },
{ 494, 125 },
{ 1, 10 },
{ 494, 500 },
{ 1, 125 },
{ 494, 125 },
{ 587, 125 },
{ 740, 125 },
{ 1, 10 },
{ 740, 125 },
{ 1, 125 },
{ 659, 125 },
{ 1, 250 },
{ 740, 500 },
{ 659, 125 },
{ 1, 250 },
{ 440, 125 },
{ 494, 125 },
{ 587, 125 },
{ 1, 10 },
{ 587, 125 },
{ 1, 125 },
{ 494, 125 },
{ 1, 250 },
{ 494, 500 },
{ 487, 250 },
{ 1, 125 },
{ 487, 125 },
{ 659, 125 },
{ 740, 125 },
{ 1, 125 },
{ 659, 250 },
{ 1, 10 },
{ 659, 250 },
{ 587, 250 },
{ 740, 375 },
{ 659, 375 },
{ 440, 125 },
{ 494, 125 },
{ 440, 125 },
{ 659, 250 },
{ 1, 10 },
{ 659, 125 },
{ 587, 250 },
{ 1, 10 },
{ 587, 250 },
{ 1, 10 },
{ 587, 250 },
{ 440, 125 },
{ 494, 375 },
{ 1, 10 },
{ 494, 125 },
{ 587, 125 },
{ 740, 125 },
{ 1, 125 },
{ 740, 250 },
{ 659, 250 },
{ 587, 250 },
{ 740, 250 },
{ 1, 250 },
{ 440, 125 },
{ 1, 10 },
{ 440, 125 },
{ 1, 125 },
{ 988, 125 },
{ 1, 125 },
{ 880, 250 },
{ 1, 10 },
{ 880, 375 },
{ 740, 125 },
{ 988, 125 },
{ 1, 250 },
{ 880, 125 },
{ 1, 10 },
{ 880, 125 },
{ 1, 10 },
{ 880, 125 },
{ 1, 10 },
{ 880, 125 },
{ 988, 250 },
{ 740, 375 },
{ 659, 375 },
{ 587, 375 },
{ 659, 125 },
{ 740, 250 },
{ 659, 125 },
{ 740, 125 },
{ 988, 125 },
{ 1, 10 },
{ 988, 125 },
{ 1, 10 },
{ 988, 125 },
{ 1, 10 },
{ 988, 125 },
{ 1, 10 },
{ 880, 125 },
{ 1, 88 },
{ 880, 125 },
{ 1, 10 },
{ 880, 125 },
{ 740, 125 },
{ 1, 88 },
{ 740, 125 },
{ 1, 88 },
{ 880, 125 },
{ 988, 375 },
{ 880, 250 },
{ 988, 250 },
{ 740, 375 },
{ 659, 375 },
{ 587 },
{ 494, 375 },
{ 440, 125 },
{ 494, 250 },
{ 1, 125 },
{ 440, 125 },
{ 494, 125 },
{ 587, 375 },
{ 659, 500 },
{ 1, 88 },
{ 784, 125 },
{ 740, 125 },
{ 784, 125 },
{ 1, 88 },
{ 784, 125 },
{ 659, 125 },
{ 740, 125 },
{ 1, 88 },
{ 659, 125 },
{ 587, 125 },
{ 659, 125 },
{ 1, 88 },
{ 494, 125 },
{ 1, 10 },
{ 494, 500 },
{ 440, 250 },
{ 494, 125 },
{ 1, 10 },
{ 494, 125 },
{ 587, 125 },
{ 659, 125 },
{ 740, 125 },
{ 1, 10 },
{ 740, 125 },
{ 659, 375 },
{ 587, 375 },
{ 659, 125 },
{ 740, 250 },
{ 659, 125 },
{ 740, 125 },
{ 1, 250 },
{ 988, 125 },
{ 1, 10 },
{ 988, 125 },
{ 1, 10 },
{ 988, 125 },
{ 1, 10 },
{ 988, 125 },
{ 1, 10 },
{ 880, 125 },
{ 1, 88 },
{ 880, 125 },
{ 1, 10 },
{ 880, 125 },
{ 740, 125 },
{ 1, 88 },
{ 740, 125 },
{ 1, 88 },
{ 880, 250 },
{ 440, 125 },
{ 1, 10 },
{ 440, 125 },
{ 494, 250 },
{ 587, 250 },
{ 740, 375 },
{ 659, 375 },
{ 587, 375 },
{ 494, 375 },
{ 440, 125 },
{ 494, 250 },
{ 587, 125 },
{ 784, 125 },
{ 740, 125 },
{ 784, 125 },
{ 1, 88 },
{ 784, 125 },
{ 659, 125 },
{ 740, 125 },
{ 1, 88 },
{ 659, 125 },
{ 587, 125 },
{ 659, 125 },
{ 1, 88 },
{ 494, 125 },
{ 1, 125 },
{ 494, 500 } };

int speaker_ctrl(unsigned char on)
{

	if (on == 0x00)
	{
		sys_outb(SPEAKER_CTRL, SPEAKER_OFF);
	}
	else
	{
		sys_outb(SPEAKER_CTRL, SPEAKER_ON);
	}

	return 0;
}

int play_music()
{
	static unsigned int i = 0;
	static long long counter = 0;

	if(rtc_counter <= music[i].time + counter)
		return 0;
	
	speaker_ctrl(0);
	timer_set_square(2, music[i].freq);
	speaker_ctrl(1);
	counter = rtc_counter;

	i++;
 
	if (i == MUSIC_SIZE)
		i = 0;

	return 0;
}
			
